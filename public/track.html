<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Music Inspector - Трек</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="nav-bar">
    <a href="index.html" >
      <div class="svg-logo"><svg fill="#D9D9D9" width="45px" height="45px" viewBox="0 0 256 256" id="Flat" xmlns="http://www.w3.org/2000/svg">
        <path d="M188.29883,43.31128a8.00224,8.00224,0,0,0-1.35889-.94751,103.67838,103.67838,0,1,0,1.35889.94751ZM128,152a24,24,0,1,1,24-24A24.0275,24.0275,0,0,1,128,152Zm88-24c0,2.47168-.10791,4.91833-.30859,7.339l-47.71875-8.41419a39.84182,39.84182,0,0,0-10.95777-26.41552l27.77808-39.671A87.83762,87.83762,0,0,1,216,128Z"/>
      </svg>
      </div>
      <div class="name-logo">Music Inspector</div>
    </a>
    <a href="about-us.html" >
    <div class="about-us-but"><svg fill="#969696" width="px" height="25px" viewBox="-3 0 19 19" xmlns="http://www.w3.org/2000/svg" class="cf-icon-svg"><path d="M12.517 12.834v1.9a1.27 1.27 0 0 1-1.267 1.267h-9.5a1.27 1.27 0 0 1-1.267-1.267v-1.9A3.176 3.176 0 0 1 3.65 9.667h5.7a3.176 3.176 0 0 1 3.167 3.167zM3.264 5.48A3.236 3.236 0 1 1 6.5 8.717a3.236 3.236 0 0 1-3.236-3.236z"/></svg></div>
    </a>
    <div class="search-bar">
      <div class="search-icon">
        <svg stroke="currentColor" fill="#969696" stroke-width="0" viewBox="0 0 512 512" class="size-4" height="25px" width="25px" xmlns="http://www.w3.org/2000/svg"><path d="M337.509 305.372h-17.501l-6.571-5.486c20.791-25.232 33.922-57.054 33.922-93.257C347.358 127.632 283.896 64 205.135 64 127.452 64 64 127.632 64 206.629s63.452 142.628 142.225 142.628c35.011 0 67.831-13.167 92.991-34.008l6.561 5.487v17.551L415.18 448 448 415.086 337.509 305.372zm-131.284 0c-54.702 0-98.463-43.887-98.463-98.743 0-54.858 43.761-98.742 98.463-98.742 54.7 0 98.462 43.884 98.462 98.742 0 54.856-43.762 98.743-98.462 98.743z"></path></svg>
      </div>
      <input type="text" class="search-input" placeholder="Поиск...">
      </div>
    <a href="login.html" class="sing-in-but">Войти</a>
    <a href="register.html" class="sing-up-but">Регистрация</a>
  </div>

  <div class="container">
    <div class="track-page">
      <div class="track-header">
        <div class="track-cover-large">
          <img id="track-cover" src="" alt="Обложка трека">
        </div>
        <div class="track-info-large">
          <h1 id="track-title">Загрузка...</h1>
          <h2 id="track-artist">Загрузка...</h2>
          <div class="track-meta">
            <span id="track-type" class="track-type-badge">Тип</span>
            <span id="track-creator" class="track-creator">Добавил: </span>
          </div>
          <div class="track-actions">
            <a id="track-link" href="#" target="_blank" class="listen-button">Слушать</a>
            <button id="mi-review-btn" class="mi-review-button">MI Рецензия</button>
          </div>
        </div>
      </div>

      <div class="track-stats">
        <div class="stat-item">
          <div id="review-count" class="stat-number">0</div>
          <div class="stat-label">Рецензий</div>
        </div>
        <div class="stat-item">
          <div id="avg-score" class="stat-number">0.0</div>
          <div class="stat-label">Средний балл</div>
        </div>
      </div>

      <div class="add-review-section">
        <h3>Добавить рецензию</h3>
        <form id="review-form">
          <div class="review-scores">
            <div class="score-input">
              <label>Мелодия:</label>
              <input type="number" name="score1" min="1" max="10" required>
            </div>
            <div class="score-input">
              <label>Аранжировка:</label>
              <input type="number" name="score2" min="1" max="10" required>
            </div>
            <div class="score-input">
              <label>Вокал:</label>
              <input type="number" name="score3" min="1" max="10" required>
            </div>
            <div class="score-input">
              <label>Текст:</label>
              <input type="number" name="score4" min="1" max="10" required>
            </div>
            <div class="score-input">
              <label>Общее впечатление:</label>
              <input type="number" name="score5" min="1" max="10" required>
            </div>
          </div>
          <textarea name="text" placeholder="Ваша рецензия..." required></textarea>
          <button type="submit">Опубликовать</button>
        </form>
      </div>

      <div class="reviews-section">
        <h3>Рецензии</h3>
        <div id="reviews-list" class="reviews-list">
          <!-- Reviews will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { getTrack, getReviewsByTrack, addReview, generateMIReview } from './js/api.js';

    const urlParams = new URLSearchParams(window.location.search);
    const trackId = urlParams.get('id');

    if (!trackId) {
      window.location.href = 'index.html';
    }

    // Load track data
    async function loadTrack() {
      try {
        const response = await getTrack(trackId);
        const track = response.track;

        document.getElementById('track-cover').src = track.cover || '../svg/album.png';
        document.getElementById('track-title').textContent = track.title;
        document.getElementById('track-artist').textContent = track.artist;
        document.getElementById('track-type').textContent = track.type === 'single' ? 'Сингл' : track.type === 'album' ? 'Альбом' : 'EP';
        document.getElementById('track-creator').textContent = `Добавил: ${track.creator_name || 'Неизвестен'}`;
        document.getElementById('track-link').href = track.link || '#';

        document.title = `${track.title} - ${track.artist} | Music Inspector`;
      } catch (error) {
        console.error('Error loading track:', error);
        alert('Ошибка загрузки трека');
      }
    }

    // Load reviews
    async function loadReviews() {
      try {
        const response = await getReviewsByTrack(trackId);
        const reviews = response.reviews;

        document.getElementById('review-count').textContent = reviews.length;

        if (reviews.length > 0) {
          const avgScore = reviews.reduce((sum, review) => sum + review.avg_score, 0) / reviews.length;
          document.getElementById('avg-score').textContent = avgScore.toFixed(1);
        }

        const reviewsList = document.getElementById('reviews-list');
        reviewsList.innerHTML = reviews.map(review => `
          <div class="review-card">
            <div class="review-header">
              <div class="review-author">
                <div class="review-avatar">
                  <img src="../people/madedev1.png" alt="avatar">
                </div>
                <div>
                  <div class="review-author-name">${review.author_name || 'Music Inspector AI'}</div>
                  <div class="review-date">${new Date(review.created_at).toLocaleDateString()}</div>
                </div>
              </div>
              <div class="review-score">${review.avg_score}</div>
            </div>
            <div class="review-scores">
              <div class="score-item">Мелодия: ${review.score1}</div>
              <div class="score-item">Аранжировка: ${review.score2}</div>
              <div class="score-item">Вокал: ${review.score3}</div>
              <div class="score-item">Текст: ${review.score4}</div>
              <div class="score-item">Общее: ${review.score5}</div>
            </div>
            <div class="review-text">${review.text}</div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading reviews:', error);
      }
    }

    // Handle review form
    document.getElementById('review-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);

      try {
        await addReview({
          trackId: parseInt(trackId),
          text: formData.get('text'),
          score1: parseInt(formData.get('score1')),
          score2: parseInt(formData.get('score2')),
          score3: parseInt(formData.get('score3')),
          score4: parseInt(formData.get('score4')),
          score5: parseInt(formData.get('score5'))
        });

        e.target.reset();
        loadReviews();
        alert('Рецензия добавлена!');
      } catch (error) {
        console.error('Error adding review:', error);
        alert('Ошибка добавления рецензии');
      }
    });

    // Handle MI review button
    document.getElementById('mi-review-btn').addEventListener('click', async () => {
      try {
        await generateMIReview({ trackId: parseInt(trackId) });
        loadReviews();
        alert('AI рецензия добавлена!');
      } catch (error) {
        console.error('Error generating MI review:', error);
        alert('Ошибка генерации AI рецензии');
      }
    });

    // Initialize
    loadTrack();
    loadReviews();
  </script>
</body>
</html>
